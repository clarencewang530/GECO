Disclaimer: This code borrowed heavily from LGM.